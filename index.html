<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LUMIX - Echangez plus simplement ðŸ˜ŠðŸ”¥</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #ff0000, #ff8800, #ffcc00);
            --gradient-primary-forMessage: linear-gradient(135deg, #ffe787f5 , #ff0000ee, #ff8800f8, #ffcc00fa);
            --gradient-secondary: linear-gradient(135deg, #ff8800, #ff0000);
            --primary-dark: #c30000;
            --primary-light: #ffa04c;
            --text-color: #333;
            --text-contrast: #333;
            --text-light: #666;
            --bg-color: #e6e6e6;
            --bg-light: #ffffff;
            --validation-back: rgb(26, 26, 26);
            --validation-col: orangered;
            --shadow: 0 3px 15px rgba(0,0,0,0.1);
            --shadow-strong: 0 6px 20px rgba(0,0,0,0.15);
            --border-radius: 16px;
            --message-radius: 18px;
            --transition: all 0.3s ease;
            --font-sans: 'Segoe UI', sans-serif;
        }
        
        [data-theme="dark"] {
            --text-color: #f0f0f0;
            --text-light: #aaaaaa;
            --text-contrast: #333;
            --validation-back: orangered;
            --validation-col: rgb(22, 22, 22);
            --bg-color: #1e1e1e;
            --bg-light: #2a2a2a;
            --shadow: 0 3px 15px rgba(0,0,0,0.25);
            --shadow-strong: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-sans);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            height: 100vh;
            overflow: scroll;
            scrollbar-width: none;
        }

        .app-container {
            display: flex;
            height: 100%;
            width: 100vw;
        }

        .sidebar {
            width: 320px;
            background: var(--bg-light);
            box-shadow: var(--shadow);
            z-index: 2;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            height: 100dvh;
            animation: slideInLeft 0.5s ease-out;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            position: relative;
            animation: fadeIn 0.5s ease;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flame-icon {
            width: 24px;
            height: 32px;
            position: relative;
            margin-right: 8px;
        }

        .flame-icon-large {
            width: 60px;
            height: 80px;
            position: relative;
            margin-bottom: 10px;
            animation: floatUpDown 3s ease-in-out infinite;
        }

        .lumix-logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: transparent;
            background: linear-gradient(135deg, #ff0000, #ff8800, #ffcc00);
            -webkit-background-clip: text;
            background-clip: text;
            position: relative;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: pulse 2s infinite, textGlow 3s infinite alternate;
        }

        .lumix-logo-large {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: -1px;
            color: transparent;
            background: linear-gradient(135deg, #ff0000, #ff8800, #ffcc00);
            -webkit-background-clip: text;
            background-clip: text;
            position: relative;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: textGlow 3s infinite alternate;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50px;
            transition: var(--transition);
        }

        .user-profile:hover {
            background-color: rgba(189, 189, 189, 0.322);
            border: 1px solid orange;
            transform: translateY(-2px);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .users-tab-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            padding: 10px 20px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary-dark);
            border-bottom-color: var(--primary-dark);
            animation: tabActivate 0.3s ease;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .search-container {
            margin: 0 20px 10px;
            position: relative;
        }

        .search-container input {
            width: 100%;
            padding: 10px 35px 10px 15px;
            border-radius: 50px;
            border: 1px solid rgba(0,0,0,0.1);
            background-color: rgba(0,0,0,0.02);
            outline: none;
            transition: var(--transition);
        }

        .search-container input:focus {
            background-color: white;
            border-color: rgba(0,0,0,0.2);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .search-container i {
            position: absolute;
            right: 15px;
            top: 12px;
            color: var(--text-light);
            animation: pulse 2s infinite;
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid transparent;
            position: relative;
        }

        .user-item:hover {
            background-color: rgba(0,0,0,0.03);
            border-left-color: var(--primary-dark);
            transform: translateX(5px);
        }

        .user-info {
            flex: 1;
            margin-left: 15px;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .last-seen {
            font-size: 12px;
            color: var(--text-light);
        }

        .online-indicator {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            bottom: 5px;
            left: 45px;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-light);
            animation: fadeIn 0.8s ease-out;
        }

        .welcome-content {
            text-align: center;
            animation: bounceIn 1s ease;
        }

        .logo-container-large {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .flame-icon-large {
            width: 60px;
            height: 80px;
            animation: floatUpDown 3s ease-in-out infinite;
        }

        .lumix-logo-large {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: -1px;
            color: transparent;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            position: relative;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: textGlow 3s infinite alternate;
        }

        .lumix-logo-large::after {
            content: 'Lumix';
            position: absolute;
            top: 3px;
            left: 0;
            opacity: 0.1;
            z-index: -1;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 10;
            animation: fadeIn 0.3s ease;
        }

        .login-card {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 360px;
            box-shadow: var(--shadow-strong);
            text-align: center;
            animation: bounceIn 0.6s ease;
            transform-origin: center;
        }

        .form-input {
            margin: 20px 0;
        }

        .form-input input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            outline: none;
            font-size: 16px;
            transition: var(--transition);
        }

        .form-input input:focus {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .login-card button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
        }

        .login-card button:hover {
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .primary-button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
        }

        .primary-button:hover {
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .secondary-button {
            background: var(--bg-light);
            color: var(--text-color);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            margin-top: 10px;
        }

        .secondary-button:hover {
            background-color: rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .danger-button {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            margin-top: 10px;
        }

        .danger-button:hover {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
            transform: translateY(-2px);
        }

        .chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        .chat-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--bg-light);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 1;
            animation: slideInDown 0.5s ease;
            position: sticky;
            top: 0;
        }

        .chat-user-info {
            display: flex;            
            align-items: center;
            gap: 15px;
        }

        .back-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-color);
            padding: 5px;
            display: none;
            transition: transform 0.3s ease;
        }

        .back-button:hover {
            transform: translateX(-3px);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-details h3 {
            margin-bottom: 2px;
        }

        .status-indicator {
            font-size: 12px;
            color: #4CAF50;
            animation: pulse 2s infinite;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .icon-button:hover {
            background-color: rgba(0,0,0,0.05);
            transform: rotate(15deg) scale(1.1);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: var(--message-radius);
            position: relative;
            transition: all 0.5s ease;
            animation-duration: 0.5s;
            animation-fill-mode: both;
            color: var(--text-color);
        }

        .message.new {
            animation-name: newMessageAnimation;
        }

        :root {
        --gradient-primary-forMessage: linear-gradient(135deg, #ffe787f5, #ff8800f0, #ff0000e6, #ffcc00f5);
        }

        @keyframes popIn {
        0% {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        }

        .message.outgoing {
            align-self: flex-end;
            max-width: 75%;
            background: var(--gradient-primary-forMessage);
            color: white;
            font-weight: 300;
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 16px 16px 4px 16px;
            border: none;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(6px);
            animation: popIn 0.25s ease-out;
            transform-origin: bottom right;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .message.outgoing:hover {
            transform: scale(1.015);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        :root {
            --shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
        }

        .message.incoming {
            align-self: flex-start;
            max-width: 75%;
            background-color: var(--bg-light);
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 16px 16px 16px 4px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
            transform-origin: bottom left;
            animation: popIn 0.25s ease-out;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .message.incoming:hover {
            transform: scale(1.015);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        }

        .message-content {
            position: relative;
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 11px;
            margin-top: 5px;
            gap: 5px;
        }

        .message.outgoing .message-meta {
            color: rgba(255,255,255,0.8);
        }

        .message.incoming .message-meta {
            color: var(--text-light);
        }

        .message-time {
            font-size: 11px;
        }

        .message-status {
            width: 9px;
            height: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-status i {
            font-size: 8px;
        }

        .message-status.sent i {
            color: white;
        }

        .message-status.delivered i {
            color: rgba(255,255,255,0.8);
        }

        .message-status.read i {
            color: rgba(16, 177, 51, 0.8);
            animation: messageRead 0.5s ease;
        }

        .message-input-container {
            display: flex;
            flex-direction: column;
            padding: 15px 20px;
            background-color: var(--bg-light);
            border-top: 1px solid rgba(0,0,0,0.05);
            gap: 10px;
            animation: slideInUp 0.5s ease;
        }

        .message-input-row {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .message-input-container {
            width: 100%;
            max-width: 76vw;
        }

        .message-input-container input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 30px;
            border: 1px solid rgba(0,0,0,0.1);
            outline: none;
            font-size: 14px;
            background-color: rgba(0,0,0,0.02);
            transition: var(--transition);
        }

        .message-input-container input:focus {
            background-color: white;
            border-color: rgba(0,0,0,0.2);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .context-menu {
            position: fixed;
            width: 180px;
            background: var(--bg-light);
            border-radius: 8px;
            box-shadow: var(--shadow-strong);
            z-index: 1000;
            overflow: hidden;
            animation: scaleIn 0.2s ease;
            transform-origin: top left;
        }

        .context-menu ul {
            list-style: none;
        }

        .context-menu li {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .context-menu li:hover {
            background-color: rgba(0,0,0,0.05);
            transform: translateX(5px);
        }

        .context-menu .delete-option {
            color: #f44336;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            animation: bounceIn 0.5s ease;
            transform-origin: center;
        }

        .modal-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            color: var(--text-contrast);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
        }

        .close-btn:hover {
            color: var(--text-color);
            transform: rotate(90deg);
        }

        .settings-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            animation: fadeInUp 0.5s ease;
            animation-fill-mode: both;
        }

        .form-group:nth-child(1) {
            animation-delay: 0.1s;
        }

        .form-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .form-group:nth-child(3) {
            animation-delay: 0.3s;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-contrast)
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            outline: none;
            font-size: 14px;
            transition: var(--transition);
        }

        .form-group input:focus {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .icon-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            background-color: rgba(0,0,0,0.05);
            color: #333;
        }

        .icon-option:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .icon-option.selected {
            border-color: var(--primary-dark);
            background: var(--gradient-primary);
            color: white;
            animation: pulse 2s infinite;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            padding: 15px 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow-strong);
            display: flex;
            align-items: center;
            max-width: 350px;
            animation: notificationEnter 0.5s ease, notificationExit 0.5s ease 4.5s forwards;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            background: var(--gradient-primary);
            color: white;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-light);
        }

        .notification-close {
            margin-left: 10px;
            cursor: pointer;
            color: var(--text-light);
            transition: transform 0.3s ease;
        }

        .notification-close:hover {
            transform: rotate(90deg);
        }

        .hidden {
            display: none !important;
        }

        .message-reply {
            background: rgba(0,0,0,0.05);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            position: relative;
            border-left: 3px solid var(--primary-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            animation: fadeInLeft 0.3s ease;
        }

        .message-tag {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-weight: 500;
            background: rgba(255, 0, 0, 0.05);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            max-width: fit-content;
        }

        .message-tag i {
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        .message-with-tag {
            position: relative;
            animation: fadeIn 0.5s ease;
            background: rgba(0,0,0,0.02);
            border-radius: 12px;
            padding: 10px 15px;
            margin: 5px 0;
            border-left: 3px solid var(--primary-dark);
        }

        .new-message-indicator {
            display: inline-block;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            line-height: 18px;
            text-align: center;
            margin-left: 5px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(255, 0, 0, 0.3);
            animation: pulse 1.5s infinite, bounceIn 0.5s;
        }

        .cancel-reply {
            margin-left: 10px;
            cursor: pointer;
            background: rgba(0,0,0,0.05);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .cancel-reply:hover {
            background: rgba(255,0,0,0.1);
            transform: rotate(90deg);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes notificationEnter {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes notificationExit {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        @keyframes flicker {
            0%, 100% { transform: scaleY(1) scaleX(1); }
            25% { transform: scaleY(1.1) scaleX(0.95); }
            50% { transform: scaleY(0.95) scaleX(1.05); }
            75% { transform: scaleY(1.05) scaleX(0.95); }
        }

        @keyframes tabActivate {
            0% { transform: translateY(5px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes floatUpDown {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes textGlow {
            0% { text-shadow: 0 0 5px rgba(255,0,0,0.3); }
            50% { text-shadow: 0 0 20px rgba(255,136,0,0.5); }
            100% { text-shadow: 0 0 5px rgba(255,0,0,0.3); }
        }

        @keyframes messageRead {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes newMessageAnimation {
            0% { opacity: 0; transform: translateY(20px);}
            100% { opacity: 1; transform: translateY(0);}
        }

        @media (max-width: 768px) {
            .message-input-container {
                width: 100%;
                max-width: 100%;
            }

            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 100vh;
                position: fixed;
                z-index: 100;
                transform: translateX(-100%);
                overflow-y: auto;
            }
            
            .sidebar.visible {
                transform: translateX(0);
                animation: slideInLeft 0.3s ease;
            }
            
            .back-button {
                display: block;
            }
            
            .message {
                max-width: 85%;
            }
            
            /* New mobile navigation button */
            .mobile-nav-toggle {
                position: fixed;
                bottom: 68px;
                right: 13px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: var(--gradient-primary);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                box-shadow: var(--shadow-strong);
                z-index: 101;
                cursor: pointer;
                border: none;
                animation: pulse 2s infinite;
            }
            
            .mobile-nav-toggle:active {
                transform: scale(0.95);
            }
            
            /* Mobile adjustments for the chat interface */
            .chat-header {
                padding: 10px 15px;
            }
            
            .message-input-container {
                padding: 10px 15px;
            }
            
            .messages-container {
                padding: 15px;
                margin-top: 0;
            }
        }
        
        .account-actions {
            margin-top: 30px;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .confirm-modal {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-strong);
            animation: bounceIn 0.6s ease;
        }
        
        .confirm-modal-title {
            font-size: 20px;
            margin-bottom: 10px;
            color: #d32f2f;
        }
        
        .confirm-modal-message {
            margin-bottom: 20px;
            color: var(--text-light);
        }
        
        .confirm-modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .confirm-modal-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .confirm-btn {
            background: #d32f2f;
            color: white;
            border: none;
        }
        
        .confirm-btn:hover {
            background: #b71c1c;
            transform: translateY(-2px);
        }
        
        .cancel-btn {
            background: transparent;
            color: var(--text-color);
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .cancel-btn:hover {
            background: rgba(0,0,0,0.05);
            transform: posY(-2px);
        }
        
        .flame-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, #ffcc00, #ff8800);
            border-radius: 50%;
            animation: particleFloat 2s ease-out forwards;
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        
        .theme-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .theme-slider {
            background: var(--gradient-primary);
        }
        
        input:focus + .theme-slider {
            box-shadow: 0 0 1px var(--primary-dark);
        }
        
        input:checked + .theme-slider:before {
            transform: translateX(30px);
        }
        
        .theme-icon {
            font-size: 18px;
            color: var(--text-light);
        }
        .message-reply {
            display: flex;
            gap: 10px;
            padding: 3px 7px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid rgb(255, 0, 0);
            border-radius: 12px;
            backdrop-filter: blur(6px);
            box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.08);
            font-size: 0.9em;
            position: relative;
        }

        .reply-content {
            display: flex;
            flex-direction: column;
            max-width: 100%;
        }

        .reply-sender {
            display: inline-block;
            background: rgba(255, 0, 0, 0.664);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 4px;
            width: fit-content;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-text {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.84em;
            line-height: 1.3em;
            word-break: break-word;
            max-height: 3.6em; /* ~3 lignes */
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container" style="margin-top: 11px;">
                    <div class="logo-container" style="margin-bottom: 20px;">
                        <h2 class="lumix-logo" style="font-size: 27px; font-weight: 700; background: linear-gradient(45deg, #ff3300, #ff9900, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Lumix&nbsp;ðŸ”¥</h2>
                    </div>
                </div>
                <div class="user-profile" id="userProfileButton">
                    <div class="avatar" id="userAvatar"></div>
                    <span id="currentUser" style="font-weight: bold; font-size: 75%;">Chargement...</span>
                </div>
            </div>
            <div class="users-tab-container">
                <div class="tabs">
                    <button class="tab active" data-tab="online">En ligne</button>
                    <button class="tab" data-tab="recent">RÃ©cent</button>
                </div>
                <div class="tab-content" id="onlineUsersTab">
                    <div class="search-container">
                        <input type="text" id="searchOnline" placeholder="Rechercher..." style="border: 1px solid var(--text-light);">
                        <i class="fas fa-search"></i>
                    </div>
                    <div id="onlineUsersList" class="users-list">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <div class="tab-content hidden" id="recentUsersTab">
                    <div class="search-container">
                        <input type="text" id="searchRecent" placeholder="Rechercher..." style="border: 1px solid var(--text-light);">
                        <i class="fas fa-search"></i>
                    </div>
                    <div id="recentUsersList" class="users-list">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="chat-container">
            <!-- Welcome screen -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-content">
                    <div class="logo-container-large">
                        <div class="logo-container" style="margin-bottom: 20px;">
                            <h2 class="lumix-logo" style="font-size: 40px; font-weight: 700; background: linear-gradient(45deg, #ff3300, #ff9900, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Lumix&nbsp;ðŸ”¥</h2>
                        </div>
                    </div>
                    <p>SÃ©lectionnez un utilisateur pour commencer une conversation</p>
                </div>
            </div>
            
            <!-- Login screen -->
            <div id="loginScreen" class="login-screen" style="display: flex; align-items: center; justify-content: center; position: fixed; inset: 0; background: linear-gradient(135deg, #3300004f, #66220034); z-index: 1000;">
              <div class="login-card" style="background: white; color: #333; padding: 40px 30px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); max-width: 350px; width: 100%; text-align: center; font-family: 'Segoe UI', sans-serif;">
                
                <div class="logo-container" style="margin-bottom: 20px;">
                  <h2 class="lumix-logo" style="font-size: 32px; font-weight: 700; background: linear-gradient(45deg, #ff3300, #ff9900, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Lumix&nbsp;ðŸ”¥</h2>
                </div>
            
                <div class="form-input" style="margin-bottom: 20px;">
                  <input type="password" id="passwordInput" placeholder="Mot de passe"
                    style="width: 100%; padding: 12px 15px; font-size: 15px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; box-sizing: border-box;"
                    onfocus="this.style.borderColor='#ff6600'" 
                    onblur="this.style.borderColor='#ddd'" />
                </div>
            
                <button id="loginBtn" class="primary-button"
                  style="width: 100%; padding: 12px; background: linear-gradient(135deg, #ff3300, #ff9900); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s;">
                  Se connecter
                </button>
                <p onclick="localStorage.clear(); window.location.reload();" style="text-decoration-line: underline; margin-top: 4px; cursor: pointer; color: rgb(58, 58, 58); font-weight: bold; font-size: 70%;">Vous voulez crÃ©er un nouveau compte ?</p>
                <p style="margin-top: 20px; color: rgb(58, 58, 58); font-weight: bold; font-size: 70%;">Vous n'avez pas de compte ou vous venez d'en crÃ©er ? tapez '1234' pour mot de passe, Lumix vous crÃ©era un compte ðŸ˜ŠðŸ”¥</p>
              </div>
            </div>
            
            
            
            <!-- Chat interface -->
            <div id="chatInterface" class="chat-interface hidden">
                <div class="chat-header" style="position: fixed; top: 0px; left: 0px; width: 100%; z-index: 1;">
                    <div class="chat-user-info" style="margin-left: auto;">
                        <div class="user-details">
                            <h3 id="chatUsername" style="text-align: right;">Utilisateur</h3>
                            <span id="userStatus" class="status-indicator" style="text-align: right;">En ligne</span>
                        </div>
                        <div class="avatar" id="chatUserAvatar"></div>
                        <button id="backButton" class="back-button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="messagesContainer" class="messages-container" style="padding-top: 80px; padding-bottom: 130px;">
                    <!-- Messages will appear here -->
                </div>
                <div class="message-input-container" style="position: fixed; bottom: 0px; right: 0px; z-index: 1; border-radius: 5px;">
                    <div id="replyPreview" class="message-with-tag hidden">
                        <div class="message-tag">
                            <i class="fas fa-reply"></i> RÃ©ponse Ã  <span id="replyToName" style="font-weight: bold;"></span>
                            <div class="cancel-reply" id="cancelReply"><i class="fas fa-times"></i></div>
                        </div>
                        <div id="replyPreviewText" class="reply-preview-text" style="font-size: 13px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                    </div>
                    <div class="message-input-row">
                        <style>
                            #messageInput{
                                border: 1px solid var(--text-light);
                            }
                        </style>
                        <input type="text" id="messageInput" placeholder="Ã‰crivez un message..." style="flex: 1;"/>
                        <button id="sendMessageBtn" class="icon-button" style="background-color: var(--validation-back);"><i style="color: var(--validation-col);" class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile navigation toggle button -->
    <button id="mobileNavToggle" class="mobile-nav-toggle hidden">
        <i class="fas fa-comments"></i>
    </button>
    
    <!-- Settings modal -->
    <div id="settingsModal" class="modal hidden" style="scrollbar-width: none;">
        <div class="modal-content" style="scrollbar-width: none;">
            <div class="modal-header" style="scrollbar-width: none;">
                <h3>ParamÃ¨tres du compte</h3>
                <button id="closeSettingsBtn" class="close-btn"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-form">
                <div class="form-group">
                    <label>Pseudo</label>
                    <input type="text" id="settingsUsername" placeholder="Votre pseudo" />
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="settingsPassword" placeholder="Nouveau mot de passe" />
                </div>
                <div class="form-group">
                    <label>IcÃ´ne</label>
                    <div class="icon-selector" id="iconSelector">
                        <!-- Icons will be populated dynamically (icones ici, je pense mettre ceux de font awasome) --> 
                    </div>
                </div>
                <button id="saveSettingsBtn" class="primary-button">Enregistrer</button>
                
                <div class="account-actions">
                    <div class="theme-toggle">
                        <i class="fas fa-sun theme-icon"></i>
                        <label class="theme-switch">
                            <input type="checkbox" id="themeToggle">
                            <span class="theme-slider"></span>
                        </label>
                        <i class="fas fa-moon theme-icon"></i>
                    </div>
                    <button id="toggleFullscreenBtn" class="secondary-button"><i class="fas fa-expand"></i> Mode plein Ã©cran</button>
                    <button id="logoutBtn" class="secondary-button"><i class="fas fa-sign-out-alt"></i> Se dÃ©connecter</button>
                    <button id="deleteAccountBtn" class="danger-button"><i class="fas fa-trash-alt"></i> Supprimer mon compte</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm modal for account deletion -->
    <div id="confirmDeleteModal" class="modal hidden">
        <div class="confirm-modal">
            <div class="confirm-modal-title">
                <i class="fas fa-exclamation-triangle"></i> Supprimer le compte
            </div>
            <div class="confirm-modal-message">
                ÃŠtes-vous sÃ»r de vouloir supprimer votre compte ? Cette action est irrÃ©versible, toutes vos donnÃ©es seront perdues.
            </div>
            <div class="confirm-modal-actions">
                <button id="cancelDeleteBtn" class="cancel-btn">Annuler</button>
                <button id="confirmDeleteBtn" class="confirm-btn">Supprimer</button>
            </div>
        </div>
    </div>
    
    <!-- Context menu for messages -->
    <div id="messageContextMenu" class="context-menu hidden">
        <ul>
            <li id="copyMessageOption"><i class="fas fa-copy"></i> Copier</li>
            <li id="replyMessageOption"><i class="fas fa-reply"></i> RÃ©pondre</li>
            <li id="deleteMessageOption" class="delete-option hidden"><i class="fas fa-trash"></i> Supprimer</li>
        </ul>
    </div>
    
    <!-- Notification container -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <script>
        // Wait for DOM to be fully loaded before initializing the app
        document.addEventListener('DOMContentLoaded', initApp);

        // Constants for the application
        const PREDEFINED_USERNAMES = [
          "Rose", "Alex", "Jordan", "Casey", "Morgan", 
          "Taylor", "Riley", "Quinn", "Skyler", "Avery", 
          "Cameron", "Dakota", "Charlie", "Bailey", "Peyton",
          "Harper", "Elliot", "Rowan", "Sage", "Finley",
          "Emery", "Blake", "Logan", "Spencer", "Ash",
          "River", "Phoenix", "Dallas", "Austin", "Brooklyn",
          "Addison", "Skylar", "Hayden", "Jesse", "Kendall",
          "Reese", "Rory", "Shiloh", "Lennox", "Harlow",
          "Wren", "Arden", "Greer", "Noah", "Liam", 
          "Emma", "Olivia", "Amelia", "Sophia", "Mia", 
          "Ethan", "Lucas", "Aiden", "Jackson", "Liam", 
          "Isabella", "Ava", "Charlotte", "Mila", "Luna", 
          "Leo", "Mateo", "Luca", "Ezra", "Hudson", 
          "Scarlett", "Zoe", "Penelope", "Chloe", "Layla", 
          "Nathan", "Caleb", "Ryan", "Evan", "Ian", 
          "Ruby", "Violet", "Willow", "Elise", "Clara", 
          "Grace", "Stella", "Audrey", "Bella", "Ivy", 
          "Maya", "Nora", "Hazel", "Lily", "Ellie", 
          "Everly", "Nova", "Sienna", "Aurora", "Autumn", 
          "Brooks", "Beau", "Finn", "Jasper", "Theo", 
          "Max", "Sam", "Ben", "Owen", "Eli"
      ];

      const ICON_OPTIONS = [
            // CatÃ©gorie : Nature
            "fa-tree", "fa-leaf", "fa-water", "fa-cloud", "fa-gamepad", 
            "fa-bell", "fa-moon", "fa-sun", "fa-snowflake", "fa-bolt", 
            "fa-fire", "fa-wind", "fa-umbrella", "fa-cloud-sun", "fa-cloud-moon", 
            "fa-cloud-showers-heavy", "fa-smog", "fa-campground", "fa-feather", "fa-frog", 
            "fa-kiwi-bird", "fa-dove", "fa-horse", "fa-spider", "fa-bug", 
            "fa-fish", "fa-paw", "fa-hippo", "fa-otter", "fa-carrot", 
            "fa-apple-alt", "fa-lemon", "fa-pepper-hot", "fa-seedling", "fa-tractor", 
            "fa-egg", "fa-cheese", "fa-drumstick-bite", "fa-ice-cream", 
            "fa-wine-glass", "fa-cocktail", "fa-beer",

            // CatÃ©gorie : Animaux
            "fa-cat", "fa-dog", "fa-fish", "fa-dragon", "fa-crow", 
            "fa-dove", "fa-horse", "fa-spider", "fa-bug", "fa-frog", 
            "fa-hippo", "fa-otter", "fa-paw", "fa-piggy-bank", "fa-dove", "fa-kiwi-bird", 
            "fa-feather", "fa-dragon", "fa-spider", "fa-bug",

            // CatÃ©gorie : Ã‰motions
            "fa-smile", "fa-frown", "fa-meh", "fa-grin", "fa-grin-beam", 
            "fa-grin-hearts", "fa-grin-squint", "fa-grin-stars", "fa-grin-tears", 
            "fa-grin-tongue", "fa-grin-tongue-squint", "fa-grin-tongue-wink", 
            "fa-grin-wink", "fa-kiss", "fa-kiss-beam", "fa-kiss-wink-heart", 
            "fa-laugh", "fa-laugh-beam", "fa-laugh-squint", "fa-laugh-wink", 
            "fa-sad-cry", "fa-sad-tear", "fa-smile-beam", "fa-smile-wink", 
            "fa-surprise", "fa-tired", "fa-angry", "fa-flushed", "fa-grimace",

            // CatÃ©gorie : Objets
            "fa-bell", "fa-book", "fa-camera", "fa-coffee", "fa-gamepad", 
            "fa-gift", "fa-glass-cheers", "fa-guitar", "fa-key", "fa-lightbulb", 
            "fa-lock", "fa-microphone", "fa-mobile", "fa-music", "fa-palette", 
            "fa-pencil-alt", "fa-phone", "fa-plane", "fa-rocket", "fa-suitcase", 
            "fa-tablet", "fa-tv", "fa-umbrella", "fa-wallet", "fa-wrench", 
            "fa-anchor", "fa-bath", "fa-bed", "fa-bicycle", "fa-binoculars", 
            "fa-bomb", "fa-briefcase", "fa-broom", "fa-calendar", "fa-car", 
            "fa-chair", "fa-clock", "fa-coins", "fa-comment", "fa-dice", 
            "fa-door-closed", "fa-envelope", "fa-eye",

            // CatÃ©gorie : Aliments
            "fa-apple-alt", "fa-bacon", "fa-birthday-cake", "fa-bread-slice", 
            "fa-cheese", "fa-cookie", "fa-drumstick-bite", "fa-egg", "fa-fish", 
            "fa-hamburger", "fa-hotdog", "fa-ice-cream", "fa-lemon", "fa-pepper-hot", 
            "fa-pizza-slice", "fa-seedling", "fa-carrot", "fa-candy-cane", 
            "fa-shrimp", "fa-wine-bottle",

            // CatÃ©gorie : Sports
            "fa-basketball-ball", "fa-football-ball", "fa-baseball-ball", 
            "fa-volleyball-ball", "fa-bowling-ball", "fa-dumbbell", "fa-running", 
            "fa-swimmer", "fa-table-tennis", "fa-biking", "fa-skating", "fa-skiing", 
            "fa-snowboarding", "fa-hiking", "fa-hockey-puck", "fa-medal", 
            "fa-puzzle-piece", "fa-quidditch", "fa-trophy", "fa-weight", 
            "fa-wheelchair", "fa-wind", "fa-snowflake", "fa-sun",

            // CatÃ©gorie : Technologie
            "fa-desktop", "fa-laptop", "fa-mobile", "fa-tablet", "fa-tv", 
            "fa-calculator", "fa-camera", "fa-charging-station", "fa-database", 
            "fa-download", "fa-ethernet", "fa-headphones", "fa-keyboard", 
            "fa-memory", "fa-microchip", "fa-network-wired", "fa-power-off", 
            "fa-print", "fa-router", "fa-satellite", "fa-save", "fa-server", 
            "fa-signal", "fa-sim-card", "fa-upload", "fa-video", "fa-volume-up",

            // CatÃ©gorie : Musique
            "fa-music", "fa-drum", "fa-guitar", "fa-headphones", 
            "fa-microphone", "fa-record-vinyl", "fa-volume-up", 
            "fa-volume-down", "fa-volume-mute", "fa-volume-off", "fa-play", 
            "fa-pause", "fa-stop", "fa-forward", "fa-backward", "fa-step-forward", 
            "fa-step-backward", "fa-fast-forward", "fa-fast-backward", "fa-random", 
            "fa-repeat", "fa-shuffle", "fa-eject", "fa-headset",

            // CatÃ©gorie : VÃ©hicules
            "fa-car", "fa-truck", "fa-bus", "fa-taxi", "fa-bicycle","fa-plane", "fa-ship", "fa-subway", "fa-train", "fa-ambulance", 
            "fa-firetruck", "fa-helicopter", "fa-rocket", "fa-space-shuttle", 
            "fa-trailer", "fa-tractor", "fa-sleigh",

            // CatÃ©gorie : BÃ¢timents et Lieux
            "fa-building", "fa-church", "fa-city", "fa-clinic-medical", 
            "fa-hospital", "fa-hotel", "fa-landmark", "fa-monument", 
            "fa-mosque", "fa-school", "fa-store", "fa-synagogue", "fa-university", 
            "fa-warehouse", "fa-igloo", "fa-torii-gate", "fa-tent",

            // CatÃ©gorie : MÃ©tiers et ActivitÃ©s
            "fa-user", "fa-user-nurse", "fa-user-md", "fa-user-tie", 
            "fa-user-astronaut", "fa-user-secret", "fa-user-graduate", 
            "fa-user-injured", "fa-chalkboard-teacher", "fa-hard-hat", 
            "fa-briefcase", "fa-tools", "fa-broom", "fa-hands-helping", 
            "fa-headset", "fa-stethoscope",

            // CatÃ©gorie : Symboles
            "fa-heart", "fa-star", "fa-star-half-alt", "fa-thumbs-up", 
            "fa-thumbs-down", "fa-check", "fa-times", "fa-plus", "fa-minus", 
            "fa-equals", "fa-divide", "fa-question", "fa-exclamation", 
            "fa-info", "fa-ban", "fa-bolt", "fa-bug", "fa-cog", "fa-cogs", 
            "fa-flag", "fa-globe", "fa-infinity", "fa-lightbulb", "fa-lock", 
            "fa-magnet", "fa-map", "fa-moon", "fa-recycle", "fa-search", 
            "fa-shield-alt", "fa-stopwatch", "fa-sync", "fa-trash", 
            "fa-unlock", "fa-wifi", "fa-eye", "fa-eye-slash",

            // CatÃ©gorie : Autres / Utilitaires
            "fa-battery-full", "fa-battery-half", "fa-battery-empty", 
            "fa-bell", "fa-bell-slash", "fa-book", "fa-bookmark", "fa-calendar", 
            "fa-calendar-check", "fa-clipboard", "fa-clipboard-check", 
            "fa-clock", "fa-compass", "fa-copy", "fa-download", "fa-edit", 
            "fa-envelope", "fa-file", "fa-folder", "fa-folder-open", 
            "fa-glasses", "fa-image", "fa-images", "fa-map-marker", 
            "fa-paper-plane", "fa-paperclip", "fa-print", "fa-save", 
            "fa-sticky-note", "fa-thumbtack", "fa-upload"
        ];

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBw91PX0lK1Y9OKb6F4oUn0dOBMkr5P0og",
            authDomain: "chat-c2abd.firebaseapp.com",
            databaseURL: "https://chat-c2abd-default-rtdb.firebaseio.com",
            projectId: "chat-c2abd",
            storageBucket: "chat-c2abd.appspot.com",
            messagingSenderId: "819172304642",
            appId: "1:819172304642:web:1c1c1673516db2255b841b"
        };

        // Initialize global variables
        let currentUser = null;
        let currentChatUser = null;
        let db = null;
        let usersRef = null;
        let messagesRef = null;
        let presenceRef = null;
        let usersSnapshot = null;
        let unreadMessages = {};
        let replyingToMessage = null;
        let userConnected = false;
        let messageCache = new Map(); // Cache to prevent message re-renders

        // Main initialization function
        function initApp() {
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            // Setup SVG gradient for flame icon
            setupSVGGradient();
            
            // Initialize theme from localStorage
            initTheme();
            
            // Check if user already exists in localStorage
            const userId = localStorage.getItem('lumixUserId');
            
            if (userId) {
                // Verify if user exists in database
                db.ref(`users/${userId}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            // User exists, show login
                            document.getElementById('loginScreen').classList.remove('hidden');
                            
                            // Setup login form handling
                            document.getElementById('loginBtn').addEventListener('click', () => {
                                const password = document.getElementById('passwordInput').value;
                                loginExistingUser(userId, password);
                            });
                            
                            // Allow Enter key to login
                            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    const password = document.getElementById('passwordInput').value;
                                    loginExistingUser(userId, password);
                                }
                            });
                        } else {
                            // User doesn't exist anymore, create new one
                            console.log("User ID exists in localStorage but not in database. Creating new user.");
                            localStorage.clear();
                            showNotification(
                                'Attention !',
                                'Votre profil a Ã©tÃ© rÃ©initialisÃ©, Nouveau mot de passe: \'1234\'',
                                'fa-user-info'
                            );
                            createNewUser();
                        }
                    })
                    .catch(error => {
                        console.error("Error checking user existence:", error);
                        localStorage.removeItem('lumixUserId');
                        localStorage.clear();
                    });
            } else {
                // New user, create account automatically
                localStorage.clear();
                createNewUser();
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize mobile navigation
            initMobileNavigation();
        }

        // Setup the SVG gradient for the flame icon
        function setupSVGGradient() {
            // Create SVG defs element for gradient definitions
            const svgDefs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            
            // Create linear gradient
            const gradient = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
            gradient.setAttribute("id", "flameFill");
            gradient.setAttribute("gradientTransform", "rotate(90)");
            
            // Create gradient stops
            const stop1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop1.setAttribute("offset", "0%");
            stop1.setAttribute("stop-color", "#ff0000");
            
            const stop2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop2.setAttribute("offset", "50%");
            stop2.setAttribute("stop-color", "#ff8800");
            
            const stop3 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
            stop3.setAttribute("offset", "100%");
            stop3.setAttribute("stop-color", "#1a237e");
            
            // Append stops to gradient
            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            gradient.appendChild(stop3);
            
            // Append gradient to defs
            svgDefs.appendChild(gradient);
            
            // Append defs to body
            document.body.appendChild(svgDefs);
        }

        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('lumixTheme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) themeToggle.checked = true;
            }
        }

        // Create a new user account
        function createNewUser() {
            // Generate random user data
            const username = PREDEFINED_USERNAMES[Math.floor(Math.random() * PREDEFINED_USERNAMES.length)];
            const iconClass = ICON_OPTIONS[Math.floor(Math.random() * ICON_OPTIONS.length)];
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Create user object with default password
            const userData = {
                username: username,
                icon: iconClass,
                password: '1234', 
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save user to database
            db.ref(`users/${userId}`).set(userData)
                .then(() => {
                    // Save user credentials to localStorage
                    localStorage.setItem('lumixUserId', userId);
                    
                    // Set current user
                    currentUser = {
                        id: userId,
                        ...userData
                    };
                    
                    // Setup presence updates
                    setupPresence(userId);
                    
                    // Initialize app with new user
                    initializeAfterAuth();
                    
                    // Show welcome notification to change settings
                    showNotification(
                        'Bienvenue sur Lumix!', 
                        'Vous pouvez personnaliser votre profil dans les paramÃ¨tres.',
                        'fa-user-plus'
                    );
                    document.getElementById('loginScreen').classList.add('hidden');
                })
                .catch(error => {
                    console.error('Error creating new user:', error);
                    showNotification('Erreur', 'Impossible de crÃ©er un nouveau compte.', 'fa-exclamation-circle');
                });
        }

        // Setup real-time presence updates
        function setupPresence(userId) {
            // Create a reference to this user's specific status node
            const userStatusRef = db.ref(`presence/${userId}`);
            
            // Create a reference to the special '.info/connected' path in Firebase
            const connectedRef = db.ref('.info/connected');
            
            // When the client's connection state changes
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    userConnected = true;
                    
                    // We're connected (or reconnected)
                    console.log('Connected to Firebase!');
                    
                    // Remove old status
                    userStatusRef.onDisconnect().remove();
                    
                    // Set the user as online
                    userStatusRef.set(true);
                    
                    // Update presence every 15 seconds to keep it fresh
                    if (window.presenceInterval) {
                        clearInterval(window.presenceInterval);
                    }
                    
                    window.presenceInterval = setInterval(() => {
                        userStatusRef.set(true);
                    }, 15000);
                    
                    // When the user disconnects, update lastSeen timestamp
                    db.ref(`users/${userId}/lastSeen`).onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                } else {
                    userConnected = false;
                    if (window.presenceInterval) {
                        clearInterval(window.presenceInterval);
                    }
                    console.log('Disconnected from Firebase');
                }
            });
        }

        // Initialize app after authentication
        function initializeAfterAuth() {
            // Update UI with user data
            updateUserUI();
            
            // Setup Firebase references
            usersRef = db.ref('users');
            presenceRef = db.ref('presence');
            
            // Setup real-time listeners
            setupRealTimeListeners();
            
            // Load unread messages
            loadUnreadMessages();
        }

        // Setup all real-time listeners for the app
        function setupRealTimeListeners() {
            // Listen for users changes with immediate callback
            usersRef.on('value', snapshot => {
                usersSnapshot = snapshot.val() || {};
                updateOnlineUsers();
            });
            
            // Listen for presence changes with immediate callback
            presenceRef.on('value', snapshot => {
                updateOnlineUsers(snapshot);
            });
            
            // Set up a short polling interval for presence updates
            if (window.presenceUpdateInterval) {
                clearInterval(window.presenceUpdateInterval);
            }
            
            window.presenceUpdateInterval = setInterval(() => {
                presenceRef.once('value').then(snapshot => {
                    updateOnlineUsers(snapshot);
                });
            }, 3000); // Check every 3 seconds
            
            // Listen for individual user changes to ensure UI is updated promptly
            usersRef.on('child_changed', snapshot => {
                const userId = snapshot.key;
                const userData = snapshot.val();
                
                // If this is the current user, update our local data
                if (currentUser && userId === currentUser.id) {
                    currentUser = {
                        id: userId,
                        ...userData
                    };
                    updateUserUI();
                }
                
                // If this is the user we're chatting with, update their data
                if (currentChatUser && userId === currentChatUser.id) {
                    currentChatUser = {
                        id: userId,
                        ...userData
                    };
                    updateChatUserInfo();
                }
                
                // Trigger a full update of online users
                updateOnlineUsers();
            });
            
            // Listen for changes in chat data - for unread messages
            db.ref('chats').on('value', snapshot => {
                const chats = snapshot.val() || {};
                updateUnreadMessagesFromChats(chats);
            });
            
            // Listen for new chats to ensure we catch all message activity
            db.ref('chats').on('child_added', snapshot => {
                const chatId = snapshot.key;
                if (chatId.includes(currentUser.id)) {
                    // This chat involves the current user, so monitor it
                    monitorChatForUpdates(chatId);
                }
            });
        }

        // Monitor a specific chat for updates
        function monitorChatForUpdates(chatId) {
            const messagesPath = `chats/${chatId}/messages`;
            
            // Listen for new messages
            db.ref(messagesPath).on('child_added', snapshot => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                
                // If we're currently viewing this chat, mark messages as read immediately
                if (currentChatUser && getChatId(currentUser.id, currentChatUser.id) === chatId) {
                    if (message.senderId !== currentUser.id && !message.read) {
                        db.ref(`${messagesPath}/${messageId}`).update({ read: true });
                    }
                    
                    // If the message isn't already in the UI, add it
                    if (!document.querySelector(`.message[data-message-id="${messageId}"]`)) {
                        addMessageToUI(message, messageId, true);
                    }
                } else {
                    // We're not viewing this chat, update unread counts
                    const otherUserId = chatId.replace(currentUser.id, '').replace('_', '');
                    if (message.senderId !== currentUser.id) {
                        // Increment unread count
                        unreadMessages[otherUserId] = (unreadMessages[otherUserId] || 0) + 1;
                        updateUnreadCounts();
                    }
                }
            });
            
            // Listen for message updates (read status, etc.)
            db.ref(messagesPath).on('child_changed', snapshot => {
                updateMessageInUI(snapshot.val(), snapshot.key);
            });
            
            // Listen for message deletions
            db.ref(messagesPath).on('child_removed', snapshot => {
                const messageElement = document.querySelector(`.message[data-message-id="${snapshot.key}"]`);
                if (messageElement) {
                    messageElement.style.animation = 'fadeOut 0.3s ease forwards';
                    setTimeout(() => messageElement.remove(), 300);
                    // Remove from cache to prevent re-rendering
                    messageCache.delete(snapshot.key);
                }
            });
        }

        // Update the online users list
        function updateOnlineUsers(presenceSnapshot) {
            if (!usersSnapshot) return;
            
            const presenceData = presenceSnapshot ? presenceSnapshot.val() || {} : {};
            const onlineUsers = [];
            const recentUsers = [];
            
            // Process users based on online status
            Object.entries(usersSnapshot).forEach(([userId, userData]) => {
                if (userId === currentUser.id) return; // Skip current user
                
                const isOnline = Boolean(presenceData[userId]);
                
                const user = {
                    id: userId,
                    ...userData,
                    online: isOnline
                };
                
                if (isOnline) {
                    onlineUsers.push(user);
                } else {
                    recentUsers.push(user);
                }
            });
            
            // Sort online users by username
            onlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            
            // Sort recent users by last seen timestamp (most recent first)
            recentUsers.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));
            
            // Update the UI
            updateOnlineUsersList(onlineUsers);
            updateRecentUsersList(recentUsers);
            
            // If in a chat, update the status of the other user
            if (currentChatUser) {
                updateChatUserInfo(presenceData);
            }
        }

        // Update chat user's info in the UI
        function updateChatUserInfo(presenceData) {
            if (!currentChatUser) return;
            
            // Update online status
            const isOnline = presenceData ? Boolean(presenceData[currentChatUser.id]) : currentChatUser.online;
            currentChatUser.online = isOnline;
            
            // Update user status display
            const statusElement = document.getElementById('userStatus');
            const messageInput = document.getElementById('messageInput');
            statusElement.textContent = isOnline ? 'En ligne' : 'Hors ligne';
            statusElement.style.color = isOnline ? '#4CAF50' : '#999';
            messageInput.style.border = isOnline ? "1px solid lightGreen" : "1px solid var(--text-light)";
            
            // Update username (in case it was changed)
            document.getElementById('chatUsername').textContent = currentChatUser.username;
            
            // Update avatar (in case it was changed)
            const chatUserAvatar = document.getElementById('chatUserAvatar');
            chatUserAvatar.innerHTML = `<i class="fas ${currentChatUser.icon}"></i>`;
        }

        // Open chat with a user
        function openChat(user) {
            // Stop listening to any previous chat's messages
            if (messagesRef) {
                messagesRef.off();
            }
            
            currentChatUser = user;
            
            // Update chat UI
            document.getElementById('chatUsername').textContent = user.username;
            document.getElementById('userStatus').textContent = user.online ? 'En ligne' : 'Hors ligne';
            document.getElementById('userStatus').style.color = user.online ? '#4CAF50' : '#999';
            
            const chatUserAvatar = document.getElementById('chatUserAvatar');
            chatUserAvatar.innerHTML = `<i class="fas ${user.icon}"></i>`;
            
            // Clear previous messages
            document.getElementById('messagesContainer').innerHTML = '';
            messageCache.clear();
            
            // Hide welcome screen, show chat interface
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            // Setup messages reference for this chat
            const chatId = getChatId(currentUser.id, user.id);
            messagesRef = db.ref(`chats/${chatId}/messages`);
            
            // Clear reply preview
            clearReplyPreview();
            
            // Load existing messages
            loadMessages();
            
            // On mobile, hide sidebar
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('visible');
                // Show the toggle button with messages icon
                const mobileNavToggle = document.getElementById('mobileNavToggle');
                if (mobileNavToggle) {
                    mobileNavToggle.innerHTML = '<i class="fas fa-comments"></i>';
                }
            }
        }

        // Send message function
        function sendMessage() {
            if (!currentChatUser || !messagesRef) return;
            
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            
            if (messageText === '') return;
            
            // Clear input
            input.value = '';
            
            // Create message object
            const message = {
                text: messageText,
                senderId: currentUser.id,
                senderName: currentUser.username,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false
            };
            
            // If replying to a message, add reply data
            if (replyingToMessage) {
                message.replyTo = {
                    id: replyingToMessage.id,
                    text: replyingToMessage.text,
                    senderId: replyingToMessage.senderId,
                    senderName: replyingToMessage.senderName
                };
                
                // Clear reply preview
                clearReplyPreview();
            }
            
            // Send message to Firebase
            messagesRef.push(message)
                .catch(error => {
                    console.error('Error sending message:', error);
                    showNotification('Erreur', 'Impossible d\'envoyer le message.', 'fa-exclamation-circle');
                });
        }

        // Clear reply preview
        function clearReplyPreview() {
            replyingToMessage = null;
            document.getElementById('replyPreview').classList.add('hidden');
        }

        // Load messages for current chat
        function loadMessages() {
            if (!messagesRef) return;
            
            // Clear existing messages and cache
            document.getElementById('messagesContainer').innerHTML = '';
            messageCache.clear();
            
            let initialLoad = true;
            
            // Remove any existing listeners first
            messagesRef.off();
            
            messagesRef.orderByChild('timestamp').on('value', snapshot => {
                // Only process messages if we're still in the same chat
                const currentChatId = currentChatUser ? getChatId(currentUser.id, currentChatUser.id) : null;
                if (!currentChatId || currentChatId !== messagesRef.parent.key) {
                    return; // Skip if we've switched to a different chat
                }
                
                const messages = snapshot.val() || {};
                const messagesContainer = document.getElementById('messagesContainer');
                
                // Store current scroll position
                const isScrolledToBottom = initialLoad || 
                    messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;
                
                // If it's not the initial load, update only new messages
                if (!initialLoad) {
                    Object.entries(messages).forEach(([messageId, message]) => {
                        if (!messageCache.has(messageId)) {
                            addMessageToUI(message, messageId, false);
                            
                            // Mark as read if it was sent by the other user
                            if (message.senderId !== currentUser.id && !message.read) {
                                messagesRef.child(messageId).update({ read: true });
                            }
                        } else {
                            // Just update the read status if needed
                            updateMessageInUI(message, messageId);
                        }
                    });
                } else {
                    // Initial load, display all messages
                    messagesContainer.innerHTML = '';
                    messageCache.clear();
                    
                    Object.entries(messages).forEach(([messageId, message]) => {
                        addMessageToUI(message, messageId, false);
                        
                        // Mark as read if it was sent by the other user
                        if (message.senderId !== currentUser.id && !message.read) {
                            messagesRef.child(messageId).update({ read: true });
                        }
                    });
                    
                    initialLoad = false;
                }
                
                // Restore scroll position if user was at the bottom
                if (isScrolledToBottom) {
                    scrollToLatestMessage();
                }
            });
        }

        // Add a message to UI
        function addMessageToUI(message, messageId, animate = true) {
            // Check if we already rendered this message
            if (messageCache.has(messageId)) {
                // Already displayed this message, just update if needed
                updateMessageInUI(message, messageId);
                return;
            }
            
            // Mark as rendered
            messageCache.set(messageId, message);
            
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (animate) {
                messageElement.classList.add('new'); // Add animation class only if animate is true
            }
            messageElement.classList.add(message.senderId === currentUser.id ? 'outgoing' : 'incoming');
            messageElement.dataset.messageId = messageId;
            messageElement.dataset.senderId = message.senderId;
            
            // Handle right-click for context menu
            messageElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, messageElement, message, messageId);
            });
            
            // Create message content
            let contentHTML = '';
            
            if (message.replyTo) {
                contentHTML += `
                    <div class="message-reply">
                        <div class="reply-content">
                            <div class="reply-sender">${message.replyTo.senderName}</div>
                            <div class="reply-text">${message.replyTo.text}</div>
                        </div>
                    </div>
                `;
            }
            
            // Add message text
            contentHTML += `<div class="message-content">${message.text}</div>`;
            
            // Add metadata (time and read status)
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (message.senderId === currentUser.id) {
                let statusIcon = 'fa fa-eye-slash';
                let statusClass = 'sent';
                
                if (message.read) {
                    statusClass = 'read';
                    statusIcon = 'fa fa-eye';
                }
                
                contentHTML += `
                    <div class="message-meta">
                        <span class="message-time">${time}</span>
                        <span class="message-status ${statusClass}">
                            <i class="fas ${statusIcon}"></i>
                        </span>
                    </div>
                `;
            } else {
                contentHTML += `
                    <div class="message-meta">
                        <span class="message-time">${time}</span>
                    </div>
                `;
            }
            
            messageElement.innerHTML = contentHTML;
            
            // Append to container
            messagesContainer.appendChild(messageElement);
            
            // Remove animation class after animation completes if animate is true
            if (animate) {
                setTimeout(() => {
                    messageElement.classList.remove('new');
                }, 500);
            }
        }

        // Update a message in the UI
        function updateMessageInUI(message, messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            // Update read status if it's the current user's message
            if (message.senderId === currentUser.id) {
                const statusElement = messageElement.querySelector('.message-status');
                if (statusElement && message.read) {
                    statusElement.classList.remove('sent');
                    statusElement.classList.add('read');
                    statusElement.innerHTML = '<i class="fa fa-eye" style="color: #28a745;"></i>';
                }
            }
        }

        // Show message context menu
        function showMessageContextMenu(event, messageElement, message, messageId) {
            const contextMenu = document.getElementById('messageContextMenu');
            const deleteOption = document.getElementById('deleteMessageOption');
            
            // Position the context menu intelligently to keep it within viewport
            let posX = event.clientX;
            let posY = event.clientY;
            
            // Get viewport dimensions and menu dimensions
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Make sure menu is visible first for calculating dimensions
            contextMenu.classList.remove('hidden');
            contextMenu.style.opacity = '0'; // Hide visually but keep for measurement
            
            // Get menu dimensions after ensuring it's in the DOM
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;
            
            // Adjust X position to ensure menu stays within viewport
            if (posX + menuWidth > viewportWidth) {
                posX = Math.max(0, viewportWidth - menuWidth - 10);
            }
            
            // Adjust Y position to ensure menu stays within viewport
            if (posY + menuHeight > viewportHeight) {
                posY = Math.max(0, viewportHeight - menuHeight - 10);
            }
            
            // Apply the calculated position
            contextMenu.style.left = `${posX}px`;
            contextMenu.style.top = `${posY}px`;
            contextMenu.style.opacity = '1'; // Make visible again
            
            // Show delete option only for user's own messages
            deleteOption.classList.toggle('hidden', message.senderId !== currentUser.id);
            
            // Set up context menu options
            document.getElementById('copyMessageOption').onclick = () => {
                navigator.clipboard.writeText(message.text);
                contextMenu.classList.add('hidden');
                showNotification('CopiÃ©', 'Message copiÃ© dans le presse-papier.', 'fa-copy');
            };
            
            document.getElementById('replyMessageOption').onclick = () => {
                setReplyToMessage(message, messageId);
                contextMenu.classList.add('hidden');
            };
            
            document.getElementById('deleteMessageOption').onclick = () => {
                if (message.senderId === currentUser.id) {
                    deleteMessage(messageId);
                }
                contextMenu.classList.add('hidden');
            };
        }

        // Set up reply to message
        function setReplyToMessage(message, messageId) {
            replyingToMessage = {
                id: messageId,
                text: message.text,
                senderId: message.senderId,
                senderName: message.senderName
            };
            
            document.getElementById('replyToName').textContent = message.senderName;
            document.getElementById('replyPreviewText').textContent = message.text;
            document.getElementById('replyPreview').classList.remove('hidden');
            
            // Add a subtle animation to draw attention to the reply preview
            document.getElementById('replyPreview').style.animation = 'pulse 1s ease';
            setTimeout(() => {
                document.getElementById('replyPreview').style.animation = '';
            }, 1000);
            
            document.getElementById('messageInput').focus();
        }

        // Delete a message
        function deleteMessage(messageId) {
            if (!messagesRef) return;
            
            messagesRef.child(messageId).remove()
                .then(() => {
                    // Get the message element and remove it from UI immediately
                    const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.style.animation = 'fadeOut 0.3s ease forwards';
                        setTimeout(() => messageElement.remove(), 300);
                    }
                    
                    // Remove from cache to prevent re-rendering
                    messageCache.delete(messageId);
                    
                    showNotification('SupprimÃ©', 'Message supprimÃ© avec succÃ¨s.', 'fa-trash');
                })
                .catch(error => {
                    console.error('Error deleting message:', error);
                    showNotification('Erreur', 'Impossible de supprimer le message.', 'fa-exclamation-circle');
                });
        }

        // Scroll to the latest message
        function scrollToLatestMessage() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show notification
        function showNotification(title, message, icon) {
            const container = document.getElementById('notificationContainer');
            
            // Skip notifications for new messages from users
            if (title && usersSnapshot && Object.values(usersSnapshot).some(user => user.username === title)) {
                return;
            }
            
            const notification = document.createElement('div');
            notification.classList.add('notification');
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <div class="notification-close"><i class="fas fa-times"></i></div>
            `;
            
            // Add click handler for close button
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('animate__fadeOut');
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 7000);
        }

        // Mark all messages in a chat as read
        function markAllMessagesAsRead(chatId, otherUserId) {
            const chat = db.ref(`chats/${chatId}/messages`);
            
            chat.once('value', snapshot => {
                const messages = snapshot.val() || {};
                
                // Find all unread messages from the other user
                Object.entries(messages).forEach(([messageId, message]) => {
                    if (message.senderId === otherUserId && !message.read) {
                        chat.child(messageId).update({ read: true });
                    }
                });
            });
        }

        // Update the UI with unread message counts
        function updateUnreadCounts() {
            // Update online users tab
            document.querySelectorAll('#onlineUsersList .user-item').forEach(userItem => {
                const userId = userItem.dataset.userId;
                const unreadBadge = userItem.querySelector('.new-message-indicator');
                
                if (unreadMessages[userId]) {
                    if (!unreadBadge) {
                        const badge = document.createElement('span');
                        badge.classList.add('new-message-indicator');
                        badge.textContent = unreadMessages[userId];
                        userItem.querySelector('.user-name').appendChild(badge);
                    } else {
                        unreadBadge.textContent = unreadMessages[userId];
                        // Add a subtle "pop" animation when the count changes
                        unreadBadge.style.animation = 'none';
                        setTimeout(() => {
                            unreadBadge.style.animation = 'pulse 1.5s infinite, bounceIn 0.5s';
                        }, 10);
                    }
                } else if (unreadBadge) {
                    unreadBadge.remove();
                }
            });
            
            // Update recent users tab
            document.querySelectorAll('#recentUsersList .user-item').forEach(userItem => {
                const userId = userItem.dataset.userId;
                const unreadBadge = userItem.querySelector('.new-message-indicator');
                
                if (unreadMessages[userId]) {
                    if (!unreadBadge) {
                        const badge = document.createElement('span');
                        badge.classList.add('new-message-indicator');
                        badge.textContent = unreadMessages[userId];
                        userItem.querySelector('.user-name').appendChild(badge);
                    } else {
                        unreadBadge.textContent = unreadMessages[userId];
                        // Add a subtle "pop" animation when the count changes
                        unreadBadge.style.animation = 'none';
                        setTimeout(() => {
                            unreadBadge.style.animation = 'pulse 1.5s infinite, bounceIn 0.5s';
                        }, 10);
                    }
                } else if (unreadBadge) {
                    unreadBadge.remove();
                }
            });
        }

        // Load unread messages for current user
        function loadUnreadMessages() {
            db.ref('chats').once('value', snapshot => {
                const chats = snapshot.val() || {};
                updateUnreadMessagesFromChats(chats);
            });
        }

        // Update unread messages from chat data
        function updateUnreadMessagesFromChats(chats) {
            // Reset unread messages count
            unreadMessages = {};
            
            // Process each chat
            Object.entries(chats).forEach(([chatId, chatData]) => {
                // Skip if no messages
                if (!chatData || !chatData.messages) return;
                
                // Get the other user's ID from the chat ID
                const chatUsers = chatId.split('_');
                if (!chatUsers.includes(currentUser.id)) return;
                
                const otherUserId = chatUsers[0] === currentUser.id ? chatUsers[1] : chatUsers[0];
                
                // Count unread messages from the other user
                let unreadCount = 0;
                Object.values(chatData.messages).forEach(message => {
                    if (message.senderId !== currentUser.id && !message.read) {
                        unreadCount++;
                    }
                });
                
                // Only add to unreadMessages if there are unread messages
                if (unreadCount > 0) {
                    unreadMessages[otherUserId] = unreadCount;
                }
            });
            
            // Update UI to show unread counts
            updateUnreadCounts();
        }

        // Generate chat ID from two user IDs
        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        // Update online users list in UI
        function updateOnlineUsersList(users) {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = '';
            
            if (users.length === 0) {
                onlineUsersList.innerHTML = '<div class="user-item" style="justify-content: center; font-weight: bold; font-size: 70%;">Aucun utilisateur en ligne...</div>';
                return;
            }
            
            users.forEach(user => {
                if (user.username != 'undefined') {
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.dataset.userId = user.id;
                    
                    userItem.innerHTML = `
                        <div class="avatar">
                            <i class="fas ${user.icon}"></i>
                        </div>
                        <div class="online-indicator"></div>
                        <div class="user-info">
                            <div class="user-name">${user.username}${unreadMessages[user.id] ? `<span class="new-message-indicator">${unreadMessages[user.id]}</span>` : ''}</div>
                            <div class="last-seen">En ligne</div>
                        </div>
                    `;
                    
                    userItem.addEventListener('click', () => openChat(user));
                    onlineUsersList.appendChild(userItem);
                }
            });
        }

        // Update recent users list in UI
        function updateRecentUsersList(users) {
            const recentUsersList = document.getElementById('recentUsersList');
            recentUsersList.innerHTML = '';
            
            if (users.length === 0) {
                recentUsersList.innerHTML = '<div class="user-item" style="justify-content: center; font-weight: bold; font-size: 70%;">Aucun utilisateur rÃ©cemment connectÃ© ðŸ’¤</div>';
                return;
            }
            
            users.forEach(user => {
                if (user.username != 'undefined' && user.username != undefined) {
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.dataset.userId = user.id;
                    
                    // Format last seen time
                    let lastSeenText = 'DerniÃ¨re vue inconnue';
                    
                    if (user.lastSeen) {
                        const lastSeenDate = new Date(user.lastSeen);
                        const now = new Date();
                        const diffMs = now - lastSeenDate;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMins / 60);
                        const diffDays = Math.floor(diffHours / 24);
                        
                        if (diffMins < 1) {
                            lastSeenText = 'Ã€ l\'instant';
                        } else if (diffMins < 60) {
                            lastSeenText = `Il y a ${diffMins} minute${diffMins > 1 ? 's' : ''}`;
                        } else if (diffHours < 24) {
                            lastSeenText = `Il y a ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
                        } else {
                            lastSeenText = `Il y a ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
                        }
                    }
                    
                    userItem.innerHTML = `
                        <div class="avatar">
                            <i class="fas ${user.icon}"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.username}${unreadMessages[user.id] ? `<span class="new-message-indicator">${unreadMessages[user.id]}</span>` : ''}</div>
                            <div class="last-seen">${lastSeenText}</div>
                        </div>
                    `;
                    
                    userItem.addEventListener('click', () => openChat(user));
                    recentUsersList.appendChild(userItem);
                }
            });
        }

        // Update user UI with current user data
        function updateUserUI() {
            if (!currentUser) return;
            
            document.getElementById('userAvatar').innerHTML = `<i class="fas ${currentUser.icon}"></i>`;
            document.getElementById('currentUser').textContent = currentUser.username;
        }

        // Login existing user
        function loginExistingUser(userId, password) {
            db.ref(`users/${userId}`).once('value')
                .then(snapshot => {
                    const userData = snapshot.val();
                    
                    if (userData.password !== password) {
                        showNotification('Erreur', 'Mot de passe incorrect.', 'fa-exclamation-circle');
                        return;
                    }
                    
                    // Login successful
                    currentUser = {
                        id: userId,
                        ...userData
                    };
                    
                    // Setup presence updates
                    setupPresence(userId);
                    
                    // Hide login screen with animation
                    const loginScreen = document.getElementById('loginScreen');
                    loginScreen.style.animation = 'fadeOut 0.3s ease forwards';
                    
                    setTimeout(() => {
                        loginScreen.classList.add('hidden');
                        loginScreen.style.animation = '';
                    }, 300);
                    
                    // Initialize app
                    initializeAfterAuth();
                    
                    // Show welcome back notification
                    showNotification(
                        'Bienvenue Ã  nouveau!', 
                        `Ravi de vous revoir, ${userData.username}.`,
                        'fa-user'
                    );
                })
                .catch(error => {
                    console.error('Error logging in:', error);
                    showNotification('Erreur', 'ProblÃ¨me de connexion.', 'fa-exclamation-circle');
                    showNotification(
                        'Attention !',
                        'Une erreur est survenue ! Veuillez bien entrer de nouveau votre mot de passe.',
                        'fa-user-info'
                    );
                });
        }

        // Open settings modal
        function openSettings() {
            // Fill in current values
            document.getElementById('settingsUsername').value = currentUser.username;
            document.getElementById('settingsPassword').value = '';
            
            // Populate icon selector
            populateIconSelector();
            
            // Show modal
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        // Populate icon selector in settings
        function populateIconSelector() {
            const iconSelector = document.getElementById('iconSelector');
            iconSelector.innerHTML = '';
            
            ICON_OPTIONS.forEach(iconClass => {
                const iconOption = document.createElement('div');
                iconOption.classList.add('icon-option');
                if (iconClass === currentUser.icon) {
                    iconOption.classList.add('selected');
                }
                
                iconOption.innerHTML = `<i class="fas ${iconClass}"></i>`;
                
                iconOption.addEventListener('click', () => {
                    document.querySelectorAll('.icon-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    iconOption.classList.add('selected');
                });
                
                iconSelector.appendChild(iconOption);
            });
        }

        // Save user settings
        function saveSettings() {
            const newUsername = document.getElementById('settingsUsername').value.trim();
            const newPassword = document.getElementById('settingsPassword').value;
            const selectedIcon = document.querySelector('.icon-option.selected i').classList[1];
            
            if (newUsername === '') {
                showNotification('Erreur', 'Le pseudo ne peut pas Ãªtre vide.', 'fa-exclamation-circle');
                return;
            }
            
            // Create update object
            const updates = {
                username: newUsername,
                icon: selectedIcon
            };
            
            // Add password to updates only if it was changed
            if (newPassword !== '') {
                updates.password = newPassword;
            }
            
            // Update in Firebase
            db.ref(`users/${currentUser.id}`).update(updates)
                .then(() => {
                    // Update current user object
                    currentUser = {
                        ...currentUser,
                        ...updates
                    };
                    
                    // Update UI
                    updateUserUI();
                    
                    // Close settings
                    document.getElementById('settingsModal').classList.add('hidden');
                    
                    // Show success notification
                    showNotification('SuccÃ¨s', 'ParamÃ¨tres mis Ã  jour avec succÃ¨s.', 'fa-check-circle');
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    showNotification('Erreur', 'Impossible de sauvegarder les paramÃ¨tres.', 'fa-exclamation-circle');
                });
        }

        // Logout user
        function logoutUser() {
            // Remove user from localStorage
            localStorage.clear();
            
            // Clear current user data
            currentUser = null;
            
            // Remove presence
            if (currentUser && currentUser.id) {
                db.ref(`presence/${currentUser.id}`).remove();
            }
            
            // Clear any intervals
            if (window.presenceInterval) {
                clearInterval(window.presenceInterval);
            }
            
            if (window.presenceUpdateInterval) {
                clearInterval(window.presenceUpdateInterval);
            }
            
            // Show success notification
            showNotification('DÃ©connexion', 'Vous avez Ã©tÃ© dÃ©connectÃ© avec succÃ¨s.', 'fa-sign-out-alt');
            
            // Hide settings modal
            document.getElementById('settingsModal').classList.add('hidden');
            
            // Hide chat interface
            document.getElementById('chatInterface').classList.add('hidden');
            
            // Hide sidebar on mobile
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('visible');
            }
            
            // Reset UI to welcome screen
            document.getElementById('welcomeScreen').classList.remove('hidden');
            
            // Reload the page to restart the app flow
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
        
        // Show delete account confirmation modal
        function showDeleteConfirmation() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('confirmDeleteModal').classList.remove('hidden');
        }
        
        // Delete user account
        function deleteAccount() {
            if (!currentUser || !currentUser.id) {
                showNotification('Erreur', 'Impossible de supprimer le compte.', 'fa-exclamation-circle');
                return;
            }
            
            // Hide modals
            document.getElementById('confirmDeleteModal').classList.add('hidden');
            
            // Show "deleting" notification
            showNotification('Suppression', 'Suppression du compte en cours...', 'fa-spinner');
            
            // Delete user's messages from all chats
            db.ref('chats').once('value')
                .then(snapshot => {
                    const chats = snapshot.val() || {};
                    const updates = {};
                    
                    // Find chats that involve this user
                    Object.keys(chats).forEach(chatId => {
                        if (chatId.includes(currentUser.id)) {
                            updates[`chats/${chatId}`] = null;
                        }
                    });
                    
                    // Delete presence status
                    updates[`presence/${currentUser.id}`] = null;
                    
                    // Delete user data
                    updates[`users/${currentUser.id}`] = null;
                    
                    // Perform all deletions in one batch
                    return db.ref().update(updates);
                })
                .then(() => {
                    // Clear localStorage
                    localStorage.removeItem('lumixUserId');
                    
                    // Show success message
                    showNotification('Compte supprimÃ©', 'Votre compte a Ã©tÃ© supprimÃ© avec succÃ¨s.', 'fa-check-circle');
                    
                    // Clear current user
                    currentUser = null;
                    
                    // Clear any intervals
                    if (window.presenceInterval) {
                        clearInterval(window.presenceInterval);
                    }

                    localStorage.clear();
                    
                    // Wait a moment to show the notification, then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error deleting account:', error);
                    showNotification('Erreur', 'Impossible de supprimer le compte.', 'fa-exclamation-circle');
                });
        }

        // Setup event listeners for the application
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show selected tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tabId}UsersTab`).classList.remove('hidden');
                });
            });
            
            // Send message button
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            
            // Send message on Enter
            document.getElementById('messageInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Cancel reply button
            document.getElementById('cancelReply').addEventListener('click', clearReplyPreview);
            
            // Back button
            document.getElementById('backButton').addEventListener('click', () => {
                document.getElementById('chatInterface').classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
                
                // On mobile, show sidebar
                if (window.innerWidth <= 768) {
                    document.querySelector('.sidebar').classList.add('visible');
                }
            });
            
            // User profile button
            document.getElementById('userProfileButton').addEventListener('click', openSettings);
            
            // Close settings button
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('hidden');
            });
            
            // Save settings button
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            
            // Delete account button
            document.getElementById('deleteAccountBtn').addEventListener('click', showDeleteConfirmation);
            
            // Cancel delete account button
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('confirmDeleteModal').classList.add('hidden');
            });
            
            // Confirm delete account button
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteAccount);
            
            // Search inputs
            document.getElementById('searchOnline').addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('#onlineUsersList .user-item').forEach(item => {
                    if (!item || !item.querySelector('.user-name')) return;
                    
                    const username = item.querySelector('.user-name').textContent.toLowerCase();
                    item.style.display = username.includes(query) ? 'flex' : 'none';
                });
            });
            
            document.getElementById('searchRecent').addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('#recentUsersList .user-item').forEach(item => {
                    if (!item || !item.querySelector('.user-name')) return;
                    
                    const username = item.querySelector('.user-name').textContent.toLowerCase();
                    item.style.display = username.includes(query) ? 'flex' : 'none';
                });
            });
            
            // Close context menu when clicking outside
            document.addEventListener('click', event => {
                const contextMenu = document.getElementById('messageContextMenu');
                if (!contextMenu.contains(event.target) && !contextMenu.classList.contains('hidden')) {
                    contextMenu.classList.add('hidden');
                }
            });
            
            // Make modals not clickable through
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Responsive toggle for sidebar
            if (window.innerWidth <= 768) {
                document.getElementById('backButton').addEventListener('click', () => {
                    document.querySelector('.sidebar').classList.add('visible');
                });
                
                document.querySelectorAll('.user-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelector('.sidebar').classList.remove('visible');
                    });
                });
            }
            
            // Toggle fullscreen button
            document.getElementById('toggleFullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('change', toggleTheme);
        }

        // Toggle fullscreen function
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Go fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                    document.getElementById('toggleFullscreenBtn').innerHTML = '<i class="fas fa-compress"></i> Quitter plein Ã©cran';
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.getElementById('toggleFullscreenBtn').innerHTML = '<i class="fas fa-expand"></i> Mode plein Ã©cran';
                }
            }
        }

        // Listen for fullscreen change event
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.getElementById('toggleFullscreenBtn').innerHTML = '<i class="fas fa-expand"></i> Mode plein Ã©cran';
            } else {
                document.getElementById('toggleFullscreenBtn').innerHTML = '<i class="fas fa-compress"></i> Quitter plein Ã©cran';
            }
        });

        // Toggle theme between light and dark
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('lumixTheme', newTheme);
            
            // Show theme change notification
            showNotification(
                newTheme === 'dark' ? 'Mode sombre activÃ©' : 'Mode clair activÃ©',
                'Le thÃ¨me a Ã©tÃ© changÃ© avec succÃ¨s.',
                newTheme === 'dark' ? 'fa-moon' : 'fa-sun'
            );
        }
        
        // Initialize mobile navigation functionality
        function initMobileNavigation() {
            const mobileNavToggle = document.getElementById('mobileNavToggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (!mobileNavToggle) return;
            
            // Check if we need to show the mobile nav toggle
            if (window.innerWidth <= 768) {
                mobileNavToggle.classList.remove('hidden');
            } else {
                mobileNavToggle.classList.add('hidden');
            }
            
            // Toggle sidebar visibility
            mobileNavToggle.addEventListener('click', () => {
                sidebar.classList.toggle('visible');
                
                // If we're in a chat and toggle the sidebar, hide the button when sidebar is visible
                if (sidebar.classList.contains('visible')) {
                    mobileNavToggle.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    mobileNavToggle.innerHTML = '<i class="fas fa-comments"></i>';
                }
            });
            
            // Listen for window resize to adjust mobile navigation
            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768) {
                    mobileNavToggle.classList.remove('hidden');
                } else {
                    mobileNavToggle.classList.add('hidden');
                    sidebar.classList.remove('visible');
                }
            });
        }
    </script>
</body>
</html>
